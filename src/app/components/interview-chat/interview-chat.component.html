<nz-modal
  [(nzVisible)]="isVisible"
  nzTitle="Ph·ªèng V·∫•n v·ªõi Ph√°t"
  [nzWidth]="680"
  [nzFooter]="null"
  (nzOnCancel)="closeInterview()"
  nzCentered
  nzClassName="interview-modal">
  
  <ng-container *nzModalContent>
    <!-- Chat Container -->
    <div class="chat-container">
      <!-- Messages Container -->
      <div class="messages-container" #messagesContainer>
        <div class="messages-list">
          <!-- Welcome Message -->
          <div class="message-item assistant-message welcome-message" *ngIf="!currentSession || getVisibleMessages().length === 0">
            <div class="message-avatar">
              <img src="assets/images/avatar.jpeg" alt="Phat's Avatar" class="avatar-image">
            </div>
            <div class="message-content">
              <div class="message-bubble">
                <div class="welcome-text">
                  <strong>Xin ch√†o! üëã</strong><br>
                  T√¥i l√† <strong>Ph√°t</strong> - Senior Software Developer v·ªõi 10+ nƒÉm kinh nghi·ªám.<br><br>
                  T√¥i r·∫•t vui ƒë∆∞·ª£c tr√≤ chuy·ªán v·ªõi b·∫°n! B·∫°n c√≥ mu·ªën t√¥i gi·ªõi thi·ªáu v·ªÅ b·∫£n th√¢n ho·∫∑c c√≥ c√¢u h·ªèi n√†o v·ªÅ kinh nghi·ªám l√†m vi·ªác c·ªßa t√¥i kh√¥ng?
                </div>
              </div>
              <div class="message-time">
                {{ getCurrentTime() }}
                <span class="auto-response-indicator">
                  <span nz-icon nzType="robot" nzTheme="outline"></span>
                  Tr·∫£ l·ªùi t·ª± ƒë·ªông
                </span>
              </div>
            </div>
          </div>

          <!-- Chat Messages -->
          <div 
            class="message-item" 
            [ngClass]="message.role === 'user' ? 'user-message' : 'assistant-message'"
            *ngFor="let message of getVisibleMessages(); trackBy: trackByMessage">
            
            <div class="message-avatar">
              <span nz-icon 
                nzType="user" 
                nzTheme="outline"
                *ngIf="message.role === 'user'">
              </span>
              <img src="assets/images/avatar.jpeg" 
                   alt="Phat's Avatar" 
                   class="avatar-image"
                   *ngIf="message.role === 'assistant'">
            </div>
            
            <div class="message-content">
              <div class="message-bubble" [innerHTML]="formatMessageContent(message.content)">
              </div>
              <div class="message-time">
                {{ formatTime(message.timestamp) }}
                <span class="auto-response-indicator" *ngIf="message.role === 'assistant'">
                  <span nz-icon nzType="robot" nzTheme="outline"></span>
                  Tr·∫£ l·ªùi t·ª± ƒë·ªông
                </span>
                <span class="confidence-indicator" *ngIf="message.confidence && message.role === 'assistant'">
                  ‚Ä¢ Confidence: {{ message.confidence.toFixed(0) }}%
                </span>
              </div>
            </div>
          </div>

          <!-- Typing Indicator -->
          <div class="message-item assistant-message typing-indicator" *ngIf="isTyping">
            <div class="message-avatar">
              <img src="assets/images/avatar.jpeg" alt="Phat's Avatar" class="avatar-image">
            </div>
            <div class="message-content">
              <div class="message-bubble typing-bubble">
                <nz-spin nzSize="small">
                  <span>ƒêang suy nghƒ©...</span>
                </nz-spin>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Container -->
      <div class="input-container">
        <div class="input-wrapper">
          <div class="message-input-group">
            <textarea 
              #messageInput
              nz-input
              [(ngModel)]="newMessage"
              (keydown)="onKeyDown($event)"
              placeholder="H·ªèi t√¥i v·ªÅ kinh nghi·ªám, k·ªπ nƒÉng, d·ª± √°n, ho·∫∑c b·∫•t c·ª© ƒëi·ªÅu g√¨..."
              [disabled]="isTyping"
              class="message-input"
              maxlength="500"
              rows="1">
            </textarea>
            <button 
              nz-button 
              nzType="primary" 
              (click)="sendMessage()"
              [disabled]="!canSendMessage()"
              class="send-button"
              [nzLoading]="isTyping">
              <span nz-icon nzType="send" nzTheme="outline" *ngIf="!isTyping"></span>
            </button>
          </div>
          
          <!-- Character Counter -->
          <div class="character-counter" *ngIf="newMessage.length > 400">
            {{ newMessage.length }}/500
          </div>
        </div>
        
        <!-- Session Stats (Development Mode) -->
        <div class="session-stats" *ngIf="showStats && currentSession">
          <div class="stats-row">
            <span class="stat-item">
              <span nz-icon nzType="message" nzTheme="outline"></span>
              {{ getSessionStats().totalMessages }} tin nh·∫Øn
            </span>
            <span class="stat-item">
              <span nz-icon nzType="dashboard" nzTheme="outline"></span>
              {{ getSessionStats().averageConfidence.toFixed(0) }}% ƒë·ªô tin c·∫≠y
            </span>
            <span class="stat-item">
              <span nz-icon nzType="clock-circle" nzTheme="outline"></span>
              {{ formatDuration(getSessionStats().duration) }}
            </span>
          </div>
          <div class="topics-row" *ngIf="getSessionStats().topTopics.length > 0">
            <span class="topics-label">Ch·ªß ƒë·ªÅ:</span>
            <nz-tag 
              *ngFor="let topic of getSessionStats().topTopics" 
              [nzColor]="getTopicColor(topic)">
              {{ topic }}
            </nz-tag>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
          <button 
            nz-button 
            nzSize="small" 
            nzType="default" 
            (click)="toggleStats()"
            *ngIf="isDevelopmentMode()">
            <span nz-icon [nzType]="showStats ? 'eye-invisible' : 'eye'" nzTheme="outline"></span>
            {{ showStats ? '·∫®n' : 'Hi·ªán' }} th·ªëng k√™
          </button>
          <button 
            nz-button 
            nzSize="small" 
            nzType="default" 
            (click)="exportChat()"
            *ngIf="currentSession && getVisibleMessages().length > 0">
            <span nz-icon nzType="download" nzTheme="outline"></span>
            Xu·∫•t chat
          </button>
          <button 
            nz-button 
            nzSize="small" 
            nzType="default" 
            (click)="closeInterview()">
            <span nz-icon nzType="close" nzTheme="outline"></span>
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>
  </ng-container>
</nz-modal>